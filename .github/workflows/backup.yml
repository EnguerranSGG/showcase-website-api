name: Automated Backup

on:
  schedule:
    # Sauvegarde quotidienne √† 3h du matin
    - cron: '0 3 * * *'
  workflow_dispatch: # Permet de d√©clencher manuellement

jobs:
  backup-database:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Create database backup
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "
            cd /opt/air &&
            ./scripts/backup-full.sh github-actions-$(date +%Y%m%d-%H%M%S)
          "

      - name: Clean old backups (keep last 30 days)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "
            find /backups/air -name '*.sql.gz' -mtime +30 -delete
            find /backups/air -name '*.tar.gz' -mtime +30 -delete
          "

      - name: Verify backup
        run: |
          BACKUP_COUNT=$(ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "
            ls -1 /backups/air/*.sql.gz | wc -l
          ")

          if [ "$BACKUP_COUNT" -gt 0 ]; then
            echo "‚úÖ Backup created successfully. Total backups: $BACKUP_COUNT"
          else
            echo "‚ùå No backups found"
            exit 1
          fi

      - name: Notify backup status
        run: |
          echo "üíæ Daily backup completed successfully"
          echo "üìÖ Date: $(date)"
          echo "üìä Total backups: $BACKUP_COUNT"
