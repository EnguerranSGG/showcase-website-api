name: Automated Backup

on:
  schedule:
    # Sauvegarde quotidienne Ã  3h du matin
    - cron: '0 3 * * *'
  workflow_dispatch: # Permet de dÃ©clencher manuellement

jobs:
  backup-database:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Create database backup
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.HOST }} "
            cd /opt/air &&
            ./scripts/backup-full.sh github-actions-$(date +%Y%m%d-%H%M%S)
          "

      - name: Clean old backups (keep last 30 days)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.HOST }} "
            find /backups/air-app -name '*.sql.gz' -mtime +30 -delete
            find /backups/air-app -name '*.tar.gz' -mtime +30 -delete
            find /backups/postgres -name '*.sql.gz' -mtime +30 -delete
          "

      - name: Verify backup
        run: |
          BACKUP_COUNT=$(ssh -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.HOST }} "
            ls -1 /backups/air-app/*.tar.gz 2>/dev/null | wc -l
          ")

          if [ "$BACKUP_COUNT" -gt 0 ]; then
            echo "âœ… Backup created successfully. Total backups: $BACKUP_COUNT"
          else
            echo "âŒ No backups found"
            exit 1
          fi

      - name: Notify backup status
        run: |
          echo "ğŸ’¾ Daily backup completed successfully"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ“Š Total backups: $BACKUP_COUNT"
