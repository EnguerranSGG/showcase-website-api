# === Build Stage ===
FROM node:20-slim AS builder

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# âœ… Permet Ã  Prisma de connaÃ®tre les cibles binaires pendant le build
ARG PRISMA_BINARY_TARGETS
ENV PRISMA_BINARY_TARGETS=$PRISMA_BINARY_TARGETS

RUN npx prisma generate
RUN npm run build

# === Production Stage ===
FROM node:20-slim AS runner

WORKDIR /app

# âœ… DÃ©pendances systÃ¨me nÃ©cessaires pour Prisma au runtime
RUN apt-get update && apt-get install -y netcat-openbsd openssl && apt-get clean

# âœ… Copie minimale pour un runtime plus lÃ©ger
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

# âœ… Lancer le serveur aprÃ¨s avoir attendu que la base de donnÃ©es soit prÃªte
CMD sh -c "until nc -z db 5432; do echo 'ðŸ•“ Waiting for DB...'; sleep 1; done; npx prisma migrate deploy && node dist/main"
